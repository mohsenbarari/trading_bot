#!/bin/bash

# ==========================================
# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡
# ==========================================
PROJECT_DIR="/root/trading-bot/trading_bot"
FRONTEND_DIR="$PROJECT_DIR/frontend"
DIST_DIR="$PROJECT_DIR/mini_app_dist"

echo "ï¿½ Starting automated deployment..."
echo "ï¿½ğŸš€ Starting Deployment Process..."

# 1. Ø±ÙØªÙ† Ø¨Ù‡ Ù¾ÙˆØ´Ù‡ ÙØ±Ø§Ù†Øªâ€Œâ€ŒØ§Ù†Ø¯ Ùˆ Ø¨ÛŒÙ„Ø¯ Ú¯Ø±ÙØªÙ†
echo "ğŸ“¦ Building Frontend..."
cd $FRONTEND_DIR
npm install
npm run build

# Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆÙÙ‚ÛŒØª Ø¨ÛŒÙ„Ø¯
if [ $? -ne 0 ]; then
    echo "âŒ Build failed! Aborting deployment."
    exit 1
fi

echo "âœ… Build successful!"

# 2. Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ø¯Ø§ÛŒØ±Ú©ØªÙˆØ±ÛŒ Ø¨ÛŒÙ„Ø¯
if [ ! -d "$DIST_DIR" ]; then
    echo "âŒ Build directory ($DIST_DIR) not found!"
    exit 1
fi

# 3. ØªÙ†Ø¸ÛŒÙ… Ù…Ø¬ÙˆØ²Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Nginx
echo "ï¿½ Setting permissions for Nginx..."
chmod -R 755 "$DIST_DIR"

# 4. Ø±ÛŒØ¨ÛŒÙ„Ø¯ Ùˆ Ø±ÛŒØ³ØªØ§Ø±Øª Docker containers
echo "ğŸ³ Rebuilding Docker containers..."
cd $PROJECT_DIR
docker compose down
docker compose up -d --build

# Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙˆÙÙ‚ÛŒØª
if [ $? -eq 0 ]; then
    echo "âœ… Deployment completed successfully!"
    echo "ğŸŒ Application is now live!"
    echo ""
    echo "ğŸ“Š Container status:"
    docker compose ps
else
    echo "âŒ Docker deployment failed!"
    exit 1
fi
