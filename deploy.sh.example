#!/bin/bash

# ==========================================
# Nginx Server Settings (Destination)
# ==========================================
NGINX_SERVER_IP="YOUR_NGINX_SERVER_IP"
NGINX_USER="root"
REMOTE_DIR="/var/www/telegram_bot/dist/"

# ==========================================
# Project Settings (Source - App Server)
# ==========================================
PROJECT_DIR="/root/trading-bot/trading_bot"
FRONTEND_DIR="$PROJECT_DIR/frontend"
DIST_DIR="$PROJECT_DIR/mini_app_dist"

echo "üöÄ Starting Deployment Process..."

# 1. Build Frontend
echo "üì¶ Building Frontend..."
cd $FRONTEND_DIR
npm install
npm run build

# Check build status
if [ $? -ne 0 ]; then
    echo "‚ùå Build failed! Aborting deployment."
    exit 1
fi

echo "‚úÖ Build successful!"

# 2. Check build directory
if [ ! -d "$DIST_DIR" ]; then
    echo "‚ùå Build directory ($DIST_DIR) not found!"
    exit 1
fi

# 3. Sync files to Nginx Server
echo "üì° Syncing files to Nginx Server ($NGINX_SERVER_IP)..."

# Using rsync for smart copy
rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" "$DIST_DIR/" "$NGINX_USER@$NGINX_SERVER_IP:$REMOTE_DIR"

if [ $? -eq 0 ]; then
    echo "‚úÖ Deployment completed successfully!"
    echo "üåê Static files are now live on Nginx Server."
else
    echo "‚ùå Deployment failed! Please check SSH connection."
    echo "üí° Hint: Make sure you have added your SSH public key to the Nginx Server:"
    echo "   ssh-copy-id $NGINX_USER@$NGINX_SERVER_IP"
fi
